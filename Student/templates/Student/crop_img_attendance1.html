{% extends './base_student.html' %}
{% load static %}

{% block title %}
<title>Mark Attendance</title>
{% endblock title %}
{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.min.css">
{% endblock styles %}

{% block navbar %}
<header id="header" class="header d-flex align-items-center">

  <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
    <a href="#" class="logo d-flex align-items-center">
      
      <h1>EDUMATE<span>.</span></h1>
    </a>
    <nav id="navbar" class="navbar">
      <ul>
        <li>
          <a href="{% url 'submitatt' pk=pk pk2=pk2 %}" class="btn">Back</a>
        </li>
        <li class="dropdown">
          <a href="#">
            <span>Hello {{request.session.sname}}!</span> <i class="bi bi-chevron-down dropdown-indicator"></i>
          </a>
          <ul>
            <li>
              {% if pk %}
              <a href="{% url 'logout' pk=pk %}"><i style="margin-right: 6px;" class="fa-solid fa-right-from-bracket"></i>logout</a>
              {% else %}
              <a href="{% url 'logout' pk=pk1 %}"><i style="margin-right: 6px;" class="fa-solid fa-right-from-bracket"></i>logout</a>
              {% endif %}
            </li>
          </ul>
        </li>
      </ul>
    </nav><!-- .navbar -->

    <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
    <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>

  </div>
</header>
{% endblock navbar %}

{% block content %}


<div class="container" style="margin-top: 100px">
  {% if messages %}
    {% for message in messages %}
      {% if message.tags %}
        <div id="alert-message" style="background-color: #cc3c23;" class="alert {{ message.tags }}" role="alert">
          {{ message }}
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}

  <div class="container">
      <div class="">
        <div class="row">

          <div class="">
            <div class="row">

              <h2>please select the image to crop</h2>
                
                {% for image in all_marked_images %}
                <div  class="col-md-6 jumbotron text-center">
                  <div class="column">
                    <div class="row">
                  <img id="{{forloop.counter}}" style="margin-bottom: 30px;"  width="80%" src={{image}}>
                  </div>
                  <div class="row">
                  <button class="btn btn-success mx-2 my-2 " style="width: 30%;"  value="{{forloop.counter}}" onclick= updateImage({{forloop.counter}}) > Select this image</button>
                </div>
                </div>
              </div>
              {% endfor %}

              <div id="image-box" class="mb-3"></div>
              
            </div>
            
            
          </div>
        </div>
        
    <br>
    
  </div>
</div>


{% endblock %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.min.js"></script>
<script>
const imageBox = document.getElementById('image-box')
{% comment %} const imageForm = document.getElementById('image-form') {% endcomment %}
const confirmBtn = document.getElementById('confirm-btn')
const input = document.getElementById('id_file')

const csrf = document.getElementsByName('csrfmiddlewaretoken')
function updateImage(num) {
  var att_img = document.getElementById(num).src;
  console.log(att_img)
  
  imageBox.innerHTML = `<img src=${att_img} id="image" width="700px">`
  var $image = $('#image')
  console.log($image)

  $image.cropper({
      aspectRatio: 16 / 16,
      crop: function(event) {
          console.log(event.detail.x);
          console.log(event.detail.y);
          console.log(event.detail.width);
          console.log(event.detail.height);
          console.log(event.detail.rotate);
          console.log(event.detail.scaleX);
          console.log(event.detail.scaleY);
      }
  });
  
  var cropper = $image.data('cropper');
  confirmBtn.addEventListener('click', ()=>{
      cropper.getCroppedCanvas().toBlob((blob) => {
          console.log('confirmed')
          const fd = new FormData();
          fd.append('csrfmiddlewaretoken', csrf[0].value)
          fd.append('file', blob, 'my-image.png');
          console.log(fd)
      })
    })
  }


  input.addEventListener('change', ()=>{
    $.ajax({
        type:'POST',
        url: imageForm.action,
        enctype: 'multipart/form-data',
        data: fd,
        success: function(response){
            console.log('success', response)
            alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                                    Successfully saved and cropped the selected image
                                </div>`
        },
        error: function(error){
            console.log('error', error)
            alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                    Ups...something went wrong
                                </div>`
        },
        cache: false,
        contentType: false,
        processData: false,
    })
})

</script>

{% endblock script %}
